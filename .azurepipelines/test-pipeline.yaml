variables:
- group: pypi-secrets
- name: CI_USERNAME
  value: "CI Pipeline"
- name: CI_EMAIL
  value: developers@omniviser.ai

trigger:
  branches:
    include:
    - main

pr:
  branches:
    include:
    - main
pool:
  vmImage: 'ubuntu-latest'

jobs:
- job: DevelopmentStandards
  steps:
  - checkout: self
    persistCredentials: true
    clean: true

  - script: |
      # Define your naming convention regex pattern
      PATTERN="(^(chore|ci|docs|experiment|feat|fix|refactor|test)\/[A-Za-z0-9_-]+$)|main|^snyk|^dependabot"

      if [[ $(Build.Reason) == "PullRequest" ]]; then
        BRANCH="$(echo $(System.PullRequest.SourceBranch) | sed 's/refs\/heads\///')"
      else
        BRANCH="$(echo $(Build.SourceBranch) | sed 's/refs\/heads\///')"
      fi

      # Check if the branch name matches the pattern
      if [[ $BRANCH =~ $PATTERN ]]; then
          echo "Branch name '$BRANCH' is valid."
      else
          echo "Branch name [${BRANCH}] does not follow convention: \
          [chore/* | ci/* | dependabot/* | docs/* | experiment/* | feat/* | fix/* |\
          refactor/* | test/* | main | snyk | dependabot]."
          exit 1
      fi
    displayName: "Check the branch name"


  - script: |
      if [ "$BUILD_REASON" == "PullRequest" ] && [ "$TARGETBRANCH" == "refs/heads/main" ]; then
          echo "PullRequest reason for build"
          echo "Main target branch"

          pr_data=$(az repos pr show --id $PULLREQUESTID --organization $ORGANIZATION_URI)
          title=$(echo "$pr_data" | jq -r '.title')
          echo "PR Title: $title"
          echo "Keep in mind that 'Bump' and 'chore' are for AZURE BOTS ONLY, don't use them!"

          pattern="^(ci|docs|experiment|feat|fix|refactor|test|chore|Bump)"

          if [[ "$title" =~ $pattern ]]; then
              echo "PR title is valid"
          else
              echo "ERROR: PR TITLE IS INVALID"
              echo "Please ensure your PR title starts with one of the following prefixes:"
              echo "ci, Bump, docs, experiment, feat, fix, refactor, test, chore"
              exit 1
          fi
      fi
    displayName: "Validate PR title"
    env:
      AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
      ORGANIZATION_URI: https://dev.azure.com/omniviser
      PULLREQUESTID: $(System.PullRequest.PullRequestId)
      TARGETBRANCH: $(System.PullRequest.TargetBranch)
      BUILD_REASON: $(Build.Reason)

- job: CodeQuality
  steps:
  - checkout: self
    persistCredentials: true
    clean: true

  - task: UsePythonVersion@0
    inputs:
      versionSpec: "3.12"
    displayName: "Use Python 3.12"

  - bash: sudo apt-get install graphviz -f
    displayName: Install graphviz

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.local/bin:$PATH"
      echo "UV installed at: $(which uv)"
      echo "UV version: $(uv --version)"
    displayName: "Install UV"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Creating virtual environment with uv..."
      uv venv --clear
      echo "Virtual environment created."
    displayName: "Create UV Virtual Environment"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Installing dependencies with UV..."
      uv pip install -e ".[dev,docs]"
      echo "Running Ruff linting..."
      # Ruff automatically reads configuration from pyproject.toml
      uv run ruff check ./hexai
    displayName: "Run Ruff linting (replaces flake8, isort)"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running Ruff formatting check..."
      uv run ruff format ./hexai --check
    displayName: "Run Ruff formatting check (replaces Black)"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running Mypy with pyproject.toml configuration..."
      uv run mypy ./hexai
    displayName: "Run Mypy"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running Pyright with pyproject.toml configuration..."
      uv run pyright ./hexai
    displayName: "Run Pyright"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running tests with pytest configuration from pyproject.toml..."
      # Pytest automatically reads configuration from pyproject.toml
      uv run pytest --cov-report=xml:./coverage.xml --junitxml=./test-results.xml
    displayName: "Run unit tests"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running Bandit for SAST..."
      # Bandit reads configuration from pyproject.toml automatically
      uv run bandit -r ./hexai -f json -o bandit-report.json || {
          echo "Bandit found issues or encountered an error. See bandit-report.json for details."
          cat bandit-report.json
          exit 1
      }
    displayName: "Run Bandit"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Checking test structure consistency..."
      uv run scripts/check_test_structure.py
    displayName: "Check test structure consistency"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Checking examples functionality..."
      uv run scripts/check_examples.py
    displayName: "Check examples functionality"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running deptry for dependency analysis..."
      uv run deptry .
    displayName: "Run deptry"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running Safety for dependency vulnerability scanning..."
      # Safety reads configuration from pyproject.toml automatically
      uv run safety check --output json > safety-report.json || {
          echo "Safety found vulnerabilities. See safety-report.json for details."
          cat safety-report.json
          exit 1
      }
    displayName: "Run Safety - dependency vulnerability scan"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      echo "Running Gitleaks for secret detection..."
      # Install gitleaks - using fixed version for reproducibility
      GITLEAKS_VERSION="8.21.2"
      echo "Installing Gitleaks version: $GITLEAKS_VERSION"
      curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/\
      gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar -xz -C /tmp
      /tmp/gitleaks detect --source . --report-format json --report-path gitleaks-report.json || {
          echo "Gitleaks found secrets or encountered an error. See gitleaks-report.json for details."
          cat gitleaks-report.json
          exit 1
      }
    displayName: "Run Gitleaks - secret detection"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running yamllint for YAML config quality..."
      uv run yamllint -d relaxed .
    displayName: "Run yamllint - YAML config quality"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running vulture for dead code detection..."
      # Vulture reads configuration from pyproject.toml automatically
      uv run vulture hexai/ --min-confidence 90
    displayName: "Run vulture - dead code detection"

  - script: |
      set -e  # Exit immediately if a command exits with a non-zero status
      export PATH="$HOME/.local/bin:$PATH"
      echo "Running radon for code complexity analysis..."
      # Radon configuration is read from pyproject.toml
      uv run radon cc hexai/ --min B --show-complexity
    displayName: "Run radon - code complexity analysis"

- job: Documentation
  dependsOn: CodeQuality
  displayName: "Build & Validate Documentation"
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - checkout: self
    persistCredentials: true
    clean: true

  - task: UsePythonVersion@0
    inputs:
      versionSpec: "3.12"

  - script: |
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.local/bin:$PATH"
      uv venv
      uv sync --group dev --group docs 
    displayName: "Install dependencies with uv"

  - script: |
      uv run pydocstyle src/
      uv run python -m doc8 docs/
    displayName: "Check docstrings & docs formatting"

  - script: |
      uv run docs-build
    displayName: "Build documentation"

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: "docs/_build/html"
      artifactName: "docs"
    displayName: "Publish documentation artifact"
