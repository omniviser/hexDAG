variables:
  - group: pypi-secrets
  - name: CI_USERNAME
    value: "CI Pipeline"
  - name: CI_EMAIL
    value: developers@omniviser.ai

trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

jobs:
  - job: DevelopmentStandards
    steps:
      - checkout: self
        persistCredentials: true
        clean: true

      - script: |
          # Define your naming convention regex pattern
          PATTERN="(^(chore|ci|docs|experiment|feat|fix|refactor|test)\/[A-Za-z0-9_-]+$)|main|^snyk|^dependabot"

          if [[ $(Build.Reason) == "PullRequest" ]]; then
            BRANCH="$(echo $(System.PullRequest.SourceBranch) | sed 's/refs\/heads\///')"
          else
            BRANCH="$(echo $(Build.SourceBranch) | sed 's/refs\/heads\///')"
          fi

          # Check if the branch name matches the pattern
          if [[ $BRANCH =~ $PATTERN ]]; then
              echo "Branch name '$BRANCH' is valid."
          else
              echo "Branch name [${BRANCH}] does not follow convention: \
                [chore/* | ci/* | dependabot/* | docs/* | experiment/* | \
                feat/* | fix/* | refactor/* | test/* | main | snyk | \
                dependabot]."
              exit 1
          fi
        displayName: "Check the branch name"

      - script: |
          if [ "$BUILD_REASON" == "PullRequest" ] && [ "$TARGETBRANCH" == "refs/heads/main" ]; then
              echo "PullRequest reason for build"
              echo "Main target branch"

              pr_data=$(az repos pr show --id $PULLREQUESTID --organization $ORGANIZATION_URI)
              title=$(echo "$pr_data" | jq -r '.title')
              echo "PR Title: $title"
              echo "Keep in mind that 'Bump' and 'chore' are for AZURE BOTS ONLY, don't use them!"

              pattern="^(ci|docs|experiment|feat|fix|refactor|test|chore|Bump)"

              if [[ "$title" =~ $pattern ]]; then
                  echo "PR title is valid"
              else
                  echo "ERROR: PR TITLE IS INVALID"
                  echo "Please ensure your PR title starts with one of the following prefixes:"
                  echo "ci, Bump, docs, experiment, feat, fix, refactor, test, chore"
                  exit 1
              fi
          fi
        displayName: "Validate PR title"
        env:
          AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
          ORGANIZATION_URI: https://dev.azure.com/omniviser
          PULLREQUESTID: $(System.PullRequest.PullRequestId)
          TARGETBRANCH: $(System.PullRequest.TargetBranch)
          BUILD_REASON: $(Build.Reason)

  - job: CIMatrix
    displayName: "Matrix: OS × Python × profiles"
    strategy:
      matrix:
        ubuntu-py310: { vmImage: "ubuntu-latest", python: "3.10" }
        ubuntu-py311: { vmImage: "ubuntu-latest", python: "3.11" }
        ubuntu-py312: { vmImage: "ubuntu-latest", python: "3.12" }
        macos-py310: { vmImage: "macos-latest", python: "3.10" }
        macos-py311: { vmImage: "macos-latest", python: "3.11" }
        macos-py312: { vmImage: "macos-latest", python: "3.12" }
        windows-py310: { vmImage: "windows-latest", python: "3.10" }
        windows-py311: { vmImage: "windows-latest", python: "3.11" }
        windows-py312: { vmImage: "windows-latest", python: "3.12" }
    pool:
      vmImage: $(vmImage)
    variables:
      PACKAGE_NAME: "hexai"
      ARTIFACT_DIR: "artifacts"
      VENV_DIR: ".venv"
    steps:
      - checkout: self
        fetchDepth: 1

      - task: UsePythonVersion@0
        inputs:
          versionSpec: "$(python)"
          addToPath: true
        displayName: "Use Python $(python)"

      - script: |
          if [ "$(Agent.OS)" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y graphviz
          elif [ "$(Agent.OS)" = "Darwin" ]; then
            brew update
            brew install graphviz || true
          else
            echo "Ensure Graphviz installed if needed"
          fi
        displayName: "Install system deps"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Install system deps (Windows via Chocolatey)"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            choco --version
            choco install graphviz -y --no-progress

      - task: PowerShell@2
        displayName: "Verify Graphviz (dot) on PATH [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $graphvizPaths = @("C:\Program Files\Graphviz\bin",
                               "C:\Program Files (x86)\Graphviz2.38\bin")
            foreach ($p in $graphvizPaths) {
              if (Test-Path $p) { $env:PATH = "$p;$env:PATH" }
            }
            dot -V

      - script: |
          set -e
          curl -LsSf https://astral.sh/uv/install.sh | sh
        displayName: "Install UV (Unix)"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Install UV (Windows)"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            powershell -ExecutionPolicy Bypass -c "irm https://astral.sh/uv/install.ps1 | iex"
            $candidates = @("$env:USERPROFILE\.cargo\bin",
                            "$env:USERPROFILE\.local\bin")
            $found = $null
            foreach ($d in $candidates) {
              if (Test-Path (Join-Path $d 'uv.exe')) {
                $found = $d
                break
              }
            }
            if (-not $found) { $found = "$env:USERPROFILE\.cargo\bin" }
            Write-Host "Using UV from: $found"
            Write-Host "##vso[task.setvariable variable=UV_BIN_DIR]$found"

      - script: |
          set -e
          CANDIDATES=("$HOME/.local/bin" "$HOME/.cargo/bin"
                      "/Users/runner/.local/bin" "/Users/runner/.cargo/bin")
          FOUND=""
          for d in "${CANDIDATES[@]}"; do
            if [ -x "$d/uv" ]; then
              FOUND="$d"
              break
            fi
          done
          if [ -z "$FOUND" ]; then
            echo "uv not found in common dirs; listing for debug"
            ls -la "$HOME/.local/bin" || true
            ls -la "$HOME/.cargo/bin" || true
            # fallback
            FOUND="$HOME/.local/bin"
          fi
          echo "Using UV from: $FOUND"
          echo "##vso[task.setvariable variable=UV_BIN_DIR]$FOUND"
        displayName: "Locate UV and set PATH var"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - script: |
          set -e
          export PATH="$UV_BIN_DIR:$PATH"
          which uv || true
          uv venv
        displayName: "Create UV virtual environment"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Create UV virtual environment (Windows)"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            $uv = Join-Path "$(UV_BIN_DIR)" "uv.exe"
            if (-not (Test-Path $uv)) {
              Write-Error "uv.exe not found at $(UV_BIN_DIR)"
            }
            & $uv venv
            & $uv --version
            & $uv run python --version

      - script: |
          set -e
          mkdir -p $(ARTIFACT_DIR)
        displayName: "Artifacts dir"

      # BASE
      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          echo "=== Install profile: base ==="
          uv pip install -e .
          uv run python -c "import importlib, sys, platform; \
                      importlib.import_module('$(PACKAGE_NAME)'); \
                      print('OK base', sys.version.split()[0], \
                            platform.platform())"
        displayName: "Install (base)"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Install (base, Windows)"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            $uv = Join-Path "$(UV_BIN_DIR)" "uv.exe"
            & $uv pip install -e .
            & $uv run python -c "import importlib; importlib.import_module('$(PACKAGE_NAME)')"

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv pip install -e ".[dev]"
          uv pip install -e ".[viz]"
        displayName: "Install extras [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Install extras [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" pip install -e ".[dev]"
            & "$(UV_BIN_DIR)\uv.exe" pip install -e ".[viz]"
      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run ruff check ./hexai
        displayName: "Ruff check [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Ruff check [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run ruff check ./hexai

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run ruff format ./hexai --check
        displayName: "Ruff format --check [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Ruff format --check [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run ruff format ./hexai --check

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run black --check ./hexai
        displayName: "Black --check [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Black --check [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run black --check ./hexai

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run isort ./hexai --check-only
        displayName: "isort --check-only [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "isort --check-only [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run isort ./hexai --check-only

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run mypy ./hexai
        displayName: "mypy [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')


      - task: PowerShell@2
        displayName: "mypy [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run mypy ./hexai

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          echo "Running tests with coverage..."
          uv run pytest ./tests --cov=./hexai --cov-report=xml:./coverage.xml --junitxml=./test-results.xml
        displayName: "Run unit tests with coverage [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Run unit tests with coverage [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
            chcp 65001 > $null
            $env:PYTHONUTF8 = "1"
            $env:PYTHONIOENCODING = "utf-8"

            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            $graphvizPaths = @("C:\Program Files\Graphviz\bin",
                               "C:\Program Files (x86)\Graphviz2.38\bin")
            foreach ($p in $graphvizPaths) {
              if (Test-Path $p) { $env:PATH = "$p;$env:PATH" }
            }

            & "$(UV_BIN_DIR)\uv.exe" run pytest ./tests `
              --cov=./hexai `
              --cov-report=xml:./coverage.xml `
              --junitxml=./test-results.xml

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          echo "Running Bandit for SAST..."
          uv run bandit -r ./hexai -x ./tests -f json -o bandit-report.json
          BANDIT_EXIT_CODE=$?
          echo "Bandit exit code: $BANDIT_EXIT_CODE"
          if [ $BANDIT_EXIT_CODE -ne 0 ]; then
            echo "Bandit found issues or encountered an error. See bandit-report.json for details."
            cat bandit-report.json
            exit 1
          fi
        displayName: "Run Bandit [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Run Bandit [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run bandit -r ./hexai -x ./tests -f json -o bandit-report.json
            if ($LASTEXITCODE -ne 0) {
              Get-Content bandit-report.json
              exit 1
            }

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run scripts/check_test_structure.py
        displayName: "Check test structure consistency [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Check test structure consistency [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
            chcp 65001 > $null
            $env:PYTHONUTF8 = "1"
            $env:PYTHONIOENCODING = "utf-8"

            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            $graphvizPaths = @("C:\Program Files\Graphviz\bin",
                               "C:\Program Files (x86)\Graphviz2.38\bin")
            foreach ($p in $graphvizPaths) {
              if (Test-Path $p) { $env:PATH = "$p;$env:PATH" }
            }
            & "$(UV_BIN_DIR)\uv.exe" run scripts/check_test_structure.py

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run scripts/check_examples.py
        displayName: "Check examples functionality [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Check examples functionality [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
            chcp 65001 > $null
            $env:PYTHONUTF8 = "1"
            $env:PYTHONIOENCODING = "utf-8"

            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            $graphvizPaths = @("C:\Program Files\Graphviz\bin",
                               "C:\Program Files (x86)\Graphviz2.38\bin")
            foreach ($p in $graphvizPaths) {
              if (Test-Path $p) { $env:PATH = "$p;$env:PATH" }
            }
            & "$(UV_BIN_DIR)\uv.exe" run scripts/check_examples.py

      - script: |
          set -e
          export PATH="$(UV_BIN_DIR):$PATH"
          uv run deptry .
        displayName: "Run deptry [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Run deptry [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run deptry .

      - script: |
          set -e
          export PATH="$HOME/.local/bin:$PATH"
          echo "Running Safety for dependency vulnerability scanning..."
          uv run safety check --output json > safety-report.json || {
            echo "Safety found vulnerabilities. See safety-report.json for details."
            cat safety-report.json
            exit 1
          }
        displayName: "Run Safety - dependency vulnerability scan"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Run Safety [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            Write-Host "Running Safety for dependency vulnerability scanning..."
            & "$(UV_BIN_DIR)\uv.exe" run safety check --output json > safety-report.json
            if ($LASTEXITCODE -ne 0) {
              Get-Content safety-report.json
              exit 1
            }

      - script: |
          set -e
          echo "Running Gitleaks for secret detection..."
          GITLEAKS_VERSION="8.21.2"
          echo "Installing Gitleaks version: $GITLEAKS_VERSION"
          curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar -xz -C /tmp  # yamllint disable-line rule:line-length

          chmod +x /tmp/gitleaks
          /tmp/gitleaks detect --source . --report-format json --report-path gitleaks-report.json || {
          echo "Gitleaks found secrets or encountered an error. See gitleaks-report.json for details."
          cat gitleaks-report.json
          exit 1
          }
        displayName: "Run Gitleaks - secret detection"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "Run Gitleaks [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $ErrorActionPreference = "Stop"
            $version = "8.21.2"
            $zip = "$env:TEMP\gitleaks.zip"
            $url = "https://github.com/gitleaks/gitleaks/releases/download/v$version/gitleaks_${version}_windows_x64.zip" # yamllint disable-line rule:line-length
            Write-Host "Downloading Gitleaks v$version from $url"
            Invoke-WebRequest -Uri $url -OutFile $zip
            $dest = "$env:TEMP\gitleaks"
            if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
            Expand-Archive -Path $zip -DestinationPath $dest
            $exe = Join-Path $dest "gitleaks.exe"
            & $exe detect --source . --report-format json --report-path gitleaks-report.json
            if ($LASTEXITCODE -ne 0) {
              if (Test-Path gitleaks-report.json) { Get-Content gitleaks-report.json }
              exit 1
            }

      - script: |
          set -e
          export PATH="$HOME/.local/bin:$PATH"
          echo "Running yamllint for YAML config quality..."
          uv run yamllint -d relaxed .
        displayName: "Run yamllint - YAML config quality [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "yamllint [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"

            Write-Host "Converting line endings to LF..."
            Get-ChildItem -Path . -Recurse -Include *.yaml,*.yml | ForEach-Object {
              $content = Get-Content $_.FullName -Raw
              $content = $content -replace "`r`n", "`n"
              Set-Content $_.FullName -Value $content
            }

            Write-Host "Running yamllint..."
            & "$(UV_BIN_DIR)\uv.exe" run yamllint -d relaxed .

      - script: |
          set -e
          export PATH="$HOME/.local/bin:$PATH"
          echo "Running vulture for dead code detection..."
          uv run vulture hexai/ --min-confidence 90
        displayName: "Run vulture - dead code detection [Unix]"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "vulture [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run vulture hexai/ --min-confidence 90

      - script: |
          set -e
          export PATH="$HOME/.local/bin:$PATH"
          echo "Running radon for code complexity analysis..."
          uv run radon cc hexai/ --min B --show-complexity
        displayName: "Run radon - code complexity analysis"
        condition: ne(variables['Agent.OS'], 'Windows_NT')

      - task: PowerShell@2
        displayName: "radon [Windows]"
        condition: eq(variables['Agent.OS'], 'Windows_NT')
        inputs:
          targetType: inline
          script: |
            $env:PATH = "$(UV_BIN_DIR);$env:PATH"
            & "$(UV_BIN_DIR)\uv.exe" run radon cc hexai/ --min B --show-complexity
