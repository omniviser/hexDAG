$schema: http://json-schema.org/draft-07/schema#
title: hexDAG Pipeline
description: (auto-generated from builtin nodes)
type: object
properties:
  apiVersion:
    type: string
    default: v1
    description: API version
  kind:
    type: string
    const: Pipeline
    description: Resource kind (must be 'Pipeline')
  metadata:
    type: object
    properties:
      name:
        type: string
        description: Unique pipeline identifier
      description:
        type: string
        description: Pipeline description
      author:
        type: string
        description: Pipeline author
      version:
        type: string
        description: Semantic version (e.g., 1.0.0)
      tags:
        type: array
        items:
          type: string
        description: Categorization tags
    required:
    - name
  spec:
    type: object
    properties:
      ports:
        additionalProperties:
          additionalProperties: true
          type: object
        description: Port adapters configuration (LLM, database, memory)
        title: Ports
        type: object
      type_ports:
        additionalProperties:
          additionalProperties:
            additionalProperties: true
            type: object
          type: object
        description: Per-type port defaults
        title: Type Ports
        type: object
      policies:
        additionalProperties:
          additionalProperties: true
          type: object
        description: Execution policies (retry, timeout, error handling)
        title: Policies
        type: object
      aliases:
        additionalProperties:
          type: string
        description: User-defined short names for node kinds (maps alias to full module
          path)
        title: Aliases
        type: object
      custom_types:
        additionalProperties:
          additionalProperties: false
          description: Custom sanitized type definition for output_schema validation.
          properties:
            base:
              description: Base type (str, int, float, bool, Decimal)
              enum:
              - str
              - int
              - float
              - bool
              - Decimal
              title: Base
              type: string
            pattern:
              anyOf:
              - type: string
              - type: 'null'
              default: null
              description: Regex pattern for validation
              title: Pattern
            nulls:
              anyOf:
              - items:
                  type: string
                type: array
              - type: 'null'
              default: null
              description: Values to treat as null
              title: Nulls
            strip:
              anyOf:
              - type: boolean
              - type: 'null'
              default: null
              description: Strip whitespace
              title: Strip
            trim:
              anyOf:
              - type: boolean
              - type: 'null'
              default: null
              description: Trim whitespace
              title: Trim
            upper:
              anyOf:
              - type: boolean
              - type: 'null'
              default: null
              description: Convert to uppercase
              title: Upper
            lower:
              anyOf:
              - type: boolean
              - type: 'null'
              default: null
              description: Convert to lowercase
              title: Lower
            max_length:
              anyOf:
              - type: integer
              - type: 'null'
              default: null
              description: Maximum string length
              title: Max Length
            default:
              anyOf:
              - {}
              - type: 'null'
              default: null
              description: Default value if null
              title: Default
            clamp:
              anyOf:
              - items:
                  type: number
                maxItems: 2
                minItems: 2
                type: array
              - type: 'null'
              default: null
              description: '[min, max] bounds for numeric types'
              title: Clamp
            true_values:
              anyOf:
              - items:
                  type: string
                type: array
              - type: 'null'
              default: null
              description: Values to treat as true (bool type)
              title: True Values
            false_values:
              anyOf:
              - items:
                  type: string
                type: array
              - type: 'null'
              default: null
              description: Values to treat as false (bool type)
              title: False Values
            description:
              anyOf:
              - type: string
              - type: 'null'
              default: null
              description: Human-readable description of the type
              title: Description
          required:
          - base
          title: CustomTypeConfig
          type: object
        description: Custom sanitized types for output_schema validation
        title: Custom Types
        type: object
      services:
        additionalProperties:
          additionalProperties: true
          type: object
        description: 'Service configurations. Format: {service_name: {class: str,
          config: dict}}'
        title: Services
        type: object
      input_schema:
        additionalProperties: true
        type: object
        description: JSON Schema for pipeline inputs
      output_schema:
        additionalProperties: true
        type: object
        description: JSON Schema for pipeline outputs
      common_field_mappings:
        additionalProperties: true
        type: object
        description: Reusable field mapping definitions
      nodes:
        type: array
        description: List of pipeline nodes
        items:
          oneOf:
          - $ref: '#/$defs/LlmNodeSpec'
          - $ref: '#/$defs/Api_CallNodeSpec'
          - $ref: '#/$defs/CompositeNodeSpec'
          - $ref: '#/$defs/DataNodeSpec'
          - $ref: '#/$defs/ExpressionNodeSpec'
          - $ref: '#/$defs/FunctionNodeSpec'
          - $ref: '#/$defs/Service_CallNodeSpec'
          - $ref: '#/$defs/Tool_CallNodeSpec'
          - $ref: '#/$defs/AgentNodeSpec'
      events:
        type: object
        description: Event handlers for observability
        properties:
          on_node_started:
            type: array
            items:
              $ref: '#/$defs/EventHandler'
          on_node_completed:
            type: array
            items:
              $ref: '#/$defs/EventHandler'
          on_node_failed:
            type: array
            items:
              $ref: '#/$defs/EventHandler'
          on_workflow_complete:
            type: array
            items:
              $ref: '#/$defs/EventHandler'
    required:
    - nodes
required:
- kind
- metadata
- spec
$defs:
  LlmNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for llm_node type
    properties:
      kind:
        const: llm_node
        description: 'Node type: llm_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          prompt_template:
            type: string
            description: Template for the user prompt. Supports Jinja2-style {{variable}}
              syntax. Can be a string or PromptTemplate/ChatPromptTemplate object.
              Can also be provided as 'template' (alias for YAML compatibility).
            default: null
          output_schema:
            type: string
            description: Expected output schema for structured output. If provided
              with parse_json=True, the LLM response will be parsed and validated
              against this schema.
            default: null
          system_prompt:
            type: string
            description: System message to prepend to the conversation.
            default: null
          parse_json:
            type: string
            description: If True, parse the LLM response as JSON and validate against
              output_schema. Default is False (returns raw text).
            default: false
          parse_strategy:
            type: string
            description: 'JSON parsing strategy: "json", "json_in_markdown", or "yaml".
              Default is "json".'
            default: json
          template:
            type: string
            default: null
        additionalProperties: false
    required:
    - kind
    - metadata
    - spec
  Api_CallNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for api_call_node type
    properties:
      kind:
        const: api_call_node
        description: 'Node type: api_call_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          method:
            type: string
            description: 'HTTP method: GET, POST, PUT, DELETE, or PATCH.'
            default: GET
          url:
            type: string
            description: URL or path template. Supports ``{{variable}}`` syntax.
            default: ''
          headers:
            type: string
            description: Request headers. Values support ``{{variable}}`` syntax.
            default: null
          params:
            type: string
            description: Query parameters for GET requests.
            default: null
          json_body:
            type: string
            description: JSON body for POST/PUT/PATCH requests.
            default: null
          port:
            type: string
            description: 'Port name to use (default: ``"api_call"``).'
            default: api_call
          output_schema:
            type: string
            description: Optional schema for output validation.
            default: null
        additionalProperties: false
    required:
    - kind
    - metadata
    - spec
  CompositeNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for composite_node type
    properties:
      kind:
        const: composite_node
        description: 'Node type: composite_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          mode:
            type: string
            enum:
            - while
            - for-each
            - times
            - if-else
            - switch
            description: 'Control flow mode: while, for-each, times, if-else, switch'
          body:
            anyOf:
            - type: string
            - type: array
              items:
                type: object
            - type: string
              description: Module path string (e.g., 'myapp.process') or !py inline
                function
            description: 'Body to execute. Can be: - Module path string (e.g., "myapp.process")
              - Callable (compiled from !py tag) - List of node configs (inline nodes/sub-DAG)
              - None for yield-to-downstream pattern'
            default: null
          body_pipeline:
            type:
            - string
            - 'null'
            description: Path to external pipeline YAML file
            default: null
          condition:
            type:
            - string
            - 'null'
            description: Condition expression for while, if-else, or switch branches
            default: null
          items:
            type:
            - string
            - 'null'
            description: Expression resolving to iterable for for-each mode
            default: null
          item_var:
            type: string
            description: 'Variable name for current item (default: "item")'
            default: item
          index_var:
            type: string
            description: 'Variable name for current index (default: "index")'
            default: index
          count:
            type:
            - integer
            - 'null'
            description: Number of iterations for times mode
            default: null
          branches:
            type:
            - array
            - 'null'
            items:
              type: object
            description: List of condition branches for switch mode
            default: null
          else_body:
            anyOf:
            - type: string
            - type: array
              items:
                type: object
            description: Body for else branch (if-else, switch with inline execution)
            default: null
          else_action:
            type:
            - string
            - 'null'
            description: Action label for else branch (switch routing mode)
            default: null
          initial_state:
            type:
            - object
            - 'null'
            description: Initial state dict for while mode
            default: null
          state_update:
            type:
            - object
            - 'null'
            additionalProperties:
              type: string
            description: State update expressions for while mode
            default: null
          max_iterations:
            type: integer
            description: 'Safety limit for while loops (default: 100)'
            default: 100
          concurrency:
            type: integer
            description: 'Max concurrent iterations for for-each/times (default: 1)'
            default: 1
          collect:
            type: string
            enum:
            - list
            - last
            - first
            - dict
            - reduce
            description: 'Result collection mode (default: "list")'
            default: list
          key_field:
            type:
            - string
            - 'null'
            description: Field to use as key for dict collection
            default: null
          reducer:
            type:
            - string
            - 'null'
            description: Module path to reducer function for reduce collection
            default: null
          error_handling:
            type: string
            enum:
            - fail_fast
            - continue
            - collect
            description: 'Error handling strategy (default: "fail_fast")'
            default: fail_fast
          max_concurrent_nodes:
            type: integer
            default: 10
          strict_validation:
            type: boolean
            default: false
          default_node_timeout:
            type:
            - number
            - 'null'
            default: null
        additionalProperties: false
        required:
        - mode
    required:
    - kind
    - metadata
    - spec
  DataNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for data_node type
    properties:
      kind:
        const: data_node
        description: 'Node type: data_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          output:
            type: object
            description: 'Output data to return. Values can be: - Static values (strings,
              numbers, bools, etc.) - Template strings using {{variable}} syntax'
        additionalProperties: false
        required:
        - output
    required:
    - kind
    - metadata
    - spec
  ExpressionNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for expression_node type
    properties:
      kind:
        const: expression_node
        description: 'Node type: expression_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          expressions:
            type:
            - object
            - 'null'
            additionalProperties:
              type: string
            description: 'Mapping of {variable_name: expression_string}. Expressions
              are evaluated in definition order and can reference: - Input fields
              from input_mapping - Earlier computed variables - Whitelisted functions
              (len, max, min, Decimal, etc.) Optional when using merge_strategy.'
            default: null
          output_fields:
            type:
            - array
            - 'null'
            items:
              type: string
            description: Fields to include in output dict. If None, all computed expressions
              are returned.
            default: null
          merge_strategy:
            type:
            - string
            - 'null'
            enum:
            - dict
            - list
            - first
            - last
            - reduce
            description: 'Strategy for merging multiple dependency outputs: - "dict":
              Return {node_name: result} passthrough (default for multi-dep) - "list":
              Return [result1, result2, ...] in dependency order - "first": Return
              first non-None result - "last": Return last non-None result - "reduce":
              Apply reducer function to values'
            default: null
          reducer:
            anyOf:
            - type: string
            - type: string
              description: Module path string (e.g., 'myapp.process') or !py inline
                function
            description: Module path (e.g., "statistics.mean") or callable for 'reduce'
              strategy. The function receives a list of values and returns a single
              result.
            default: null
          extract_field:
            type:
            - string
            - 'null'
            description: Field to extract from each dependency result before merging.
              Uses dot notation (e.g., "result.score").
            default: null
        additionalProperties: false
    required:
    - kind
    - metadata
    - spec
  FunctionNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for function_node type
    properties:
      kind:
        const: function_node
        description: 'Node type: function_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          output_schema:
            anyOf:
            - type: object
            - type: string
            description: Output schema for validation (if None, inferred from function)
            default: null
        additionalProperties: false
    required:
    - kind
    - metadata
    - spec
  Service_CallNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for service_call_node type
    properties:
      kind:
        const: service_call_node
        description: 'Node type: service_call_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          service:
            type: string
          method:
            type: string
        additionalProperties: false
        required:
        - service
        - method
    required:
    - kind
    - metadata
    - spec
  Tool_CallNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for tool_call_node type
    properties:
      kind:
        const: tool_call_node
        description: 'Node type: tool_call_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          tool_name:
            type: string
            description: Full module path to the tool function (e.g., 'mymodule.my_tool')
          arguments:
            type:
            - object
            - 'null'
            description: 'Arguments to pass to the tool (default: {})'
            default: null
          tool_call_id:
            type:
            - string
            - 'null'
            description: Optional ID for tracking (from LLM tool calls)
            default: null
        additionalProperties: false
        required:
        - tool_name
    required:
    - kind
    - metadata
    - spec
  AgentNodeSpec:
    allOf:
    - $ref: '#/$defs/Node'
    type: object
    description: Specification for agent_node type
    properties:
      kind:
        const: agent_node
        description: 'Node type: agent_node'
      metadata:
        type: object
        properties:
          name:
            type: string
            description: Unique node identifier within the pipeline
          annotations:
            type: object
            description: Optional metadata annotations
        required:
        - name
      spec:
        type: object
        properties:
          main_prompt:
            type: string
            description: Initial reasoning prompt
          continuation_prompts:
            type:
            - object
            - 'null'
            additionalProperties:
              type: string
            description: Phase-specific prompts
            default: null
          output_schema:
            anyOf:
            - type: object
              additionalProperties:
                type: string
            - type: string
            description: Custom output schema for tool_end results
            default: null
          config:
            type:
            - string
            - 'null'
            description: Agent configuration
            default: null
        additionalProperties: false
        required:
        - main_prompt
    required:
    - kind
    - metadata
    - spec
  Node:
    type: object
    description: Base node structure
    properties:
      kind:
        type: string
      metadata:
        type: object
      spec:
        type: object
        properties:
          input_mapping:
            anyOf:
            - additionalProperties: true
              type: object
            - type: 'null'
            default: null
            description: Field mapping from upstream nodes or pipeline input. Keys
              are target field names, values use node_name.field or $input.field syntax.
              Values can also be nested dicts whose leaf strings are resolved recursively.
            title: Input Mapping
      dependencies:
        anyOf:
        - items:
            type: string
          type: array
        - type: 'null'
        default: null
        description: "Explicit execution dependencies (deprecated \u2014 prefer input_mapping\
          \ or wait_for; deps are auto-inferred from data references)"
        title: Dependencies
      wait_for:
        anyOf:
        - items:
            type: string
          type: array
        - type: 'null'
        default: null
        description: "Ordering-only dependencies \u2014 run after these nodes complete\
          \ but do not consume their data"
        title: Wait For
  EventHandler:
    type: object
    description: Event handler configuration
    properties:
      type:
        type: string
        description: Handler type (e.g., 'alert', 'metrics', 'log')
        enum:
        - alert
        - metrics
        - log
        - webhook
        - callback
      target:
        type: string
        description: Target system (e.g., 'pagerduty', 'datadog', 'slack')
      severity:
        type: string
        description: Alert severity level
        enum:
        - low
        - medium
        - high
        - critical
      tags:
        type: array
        items:
          type: string
        description: Tags for categorization
      params:
        type: object
        description: Handler-specific parameters
    required:
    - type
