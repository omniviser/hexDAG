{
    "$defs": {
        "AgentNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for agent_node type",
            "properties": {
                "kind": {
                    "const": "agent_node",
                    "description": "Node type: agent_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "additionalProperties": false,
                    "properties": {
                        "config": {
                            "default": null,
                            "description": "Agent configuration",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "continuation_prompts": {
                            "additionalProperties": {
                                "type": "string"
                            },
                            "default": null,
                            "description": "Phase-specific prompts",
                            "type": [
                                "object",
                                "null"
                            ]
                        },
                        "main_prompt": {
                            "description": "Initial reasoning prompt",
                            "type": "string"
                        },
                        "output_schema": {
                            "anyOf": [
                                {
                                    "additionalProperties": {
                                        "type": "string"
                                    },
                                    "type": "object"
                                },
                                {
                                    "type": "string"
                                }
                            ],
                            "default": null,
                            "description": "Custom output schema for tool_end results"
                        }
                    },
                    "required": [
                        "main_prompt"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "CompositeNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for composite_node type",
            "properties": {
                "kind": {
                    "const": "composite_node",
                    "description": "Node type: composite_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "additionalProperties": false,
                    "properties": {
                        "body": {
                            "anyOf": [
                                {
                                    "type": "string"
                                },
                                {
                                    "items": {
                                        "type": "object"
                                    },
                                    "type": "array"
                                },
                                {
                                    "description": "Module path string (e.g., 'myapp.process') or !py inline function",
                                    "type": "string"
                                }
                            ],
                            "default": null,
                            "description": "Body to execute. Can be: - Module path string (e.g., \"myapp.process\") - Callable (compiled from !py tag) - List of node configs (inline nodes/sub-DAG) - None for yield-to-downstream pattern"
                        },
                        "body_pipeline": {
                            "default": null,
                            "description": "Path to external pipeline YAML file",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "branches": {
                            "default": null,
                            "description": "List of condition branches for switch mode",
                            "items": {
                                "type": "object"
                            },
                            "type": [
                                "array",
                                "null"
                            ]
                        },
                        "collect": {
                            "default": "list",
                            "description": "Result collection mode (default: \"list\")",
                            "enum": [
                                "list",
                                "last",
                                "first",
                                "dict",
                                "reduce"
                            ],
                            "type": "string"
                        },
                        "concurrency": {
                            "default": 1,
                            "description": "Max concurrent iterations for for-each/times (default: 1)",
                            "type": "integer"
                        },
                        "condition": {
                            "default": null,
                            "description": "Condition expression for while, if-else, or switch branches",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "count": {
                            "default": null,
                            "description": "Number of iterations for times mode",
                            "type": [
                                "integer",
                                "null"
                            ]
                        },
                        "default_node_timeout": {
                            "default": null,
                            "type": [
                                "number",
                                "null"
                            ]
                        },
                        "else_action": {
                            "default": null,
                            "description": "Action label for else branch (switch routing mode)",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "else_body": {
                            "anyOf": [
                                {
                                    "type": "string"
                                },
                                {
                                    "items": {
                                        "type": "object"
                                    },
                                    "type": "array"
                                }
                            ],
                            "default": null,
                            "description": "Body for else branch (if-else, switch with inline execution)"
                        },
                        "error_handling": {
                            "default": "fail_fast",
                            "description": "Error handling strategy (default: \"fail_fast\")",
                            "enum": [
                                "fail_fast",
                                "continue",
                                "collect"
                            ],
                            "type": "string"
                        },
                        "index_var": {
                            "default": "index",
                            "description": "Variable name for current index (default: \"index\")",
                            "type": "string"
                        },
                        "initial_state": {
                            "default": null,
                            "description": "Initial state dict for while mode",
                            "type": [
                                "object",
                                "null"
                            ]
                        },
                        "item_var": {
                            "default": "item",
                            "description": "Variable name for current item (default: \"item\")",
                            "type": "string"
                        },
                        "items": {
                            "default": null,
                            "description": "Expression resolving to iterable for for-each mode",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "key_field": {
                            "default": null,
                            "description": "Field to use as key for dict collection",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "max_concurrent_nodes": {
                            "default": 10,
                            "type": "integer"
                        },
                        "max_iterations": {
                            "default": 100,
                            "description": "Safety limit for while loops (default: 100)",
                            "type": "integer"
                        },
                        "mode": {
                            "description": "Control flow mode: while, for-each, times, if-else, switch",
                            "enum": [
                                "while",
                                "for-each",
                                "times",
                                "if-else",
                                "switch"
                            ],
                            "type": "string"
                        },
                        "reducer": {
                            "default": null,
                            "description": "Module path to reducer function for reduce collection",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "state_update": {
                            "additionalProperties": {
                                "type": "string"
                            },
                            "default": null,
                            "description": "State update expressions for while mode",
                            "type": [
                                "object",
                                "null"
                            ]
                        },
                        "strict_validation": {
                            "default": false,
                            "type": "boolean"
                        }
                    },
                    "required": [
                        "mode"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "DataNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for data_node type",
            "properties": {
                "kind": {
                    "const": "data_node",
                    "description": "Node type: data_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "additionalProperties": false,
                    "properties": {
                        "output": {
                            "description": "Output data to return. Values can be: - Static values (strings, numbers, bools, etc.) - Template strings using {{variable}} syntax",
                            "type": "object"
                        }
                    },
                    "required": [
                        "output"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "EventHandler": {
            "description": "Event handler configuration",
            "properties": {
                "params": {
                    "description": "Handler-specific parameters",
                    "type": "object"
                },
                "severity": {
                    "description": "Alert severity level",
                    "enum": [
                        "low",
                        "medium",
                        "high",
                        "critical"
                    ],
                    "type": "string"
                },
                "tags": {
                    "description": "Tags for categorization",
                    "items": {
                        "type": "string"
                    },
                    "type": "array"
                },
                "target": {
                    "description": "Target system (e.g., 'pagerduty', 'datadog', 'slack')",
                    "type": "string"
                },
                "type": {
                    "description": "Handler type (e.g., 'alert', 'metrics', 'log')",
                    "enum": [
                        "alert",
                        "metrics",
                        "log",
                        "webhook",
                        "callback"
                    ],
                    "type": "string"
                }
            },
            "required": [
                "type"
            ],
            "type": "object"
        },
        "ExpressionNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for expression_node type",
            "properties": {
                "kind": {
                    "const": "expression_node",
                    "description": "Node type: expression_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "additionalProperties": false,
                    "properties": {
                        "expressions": {
                            "additionalProperties": {
                                "type": "string"
                            },
                            "default": null,
                            "description": "Mapping of {variable_name: expression_string}. Expressions are evaluated in definition order and can reference: - Input fields from input_mapping - Earlier computed variables - Whitelisted functions (len, max, min, Decimal, etc.) Optional when using merge_strategy.",
                            "type": [
                                "object",
                                "null"
                            ]
                        },
                        "extract_field": {
                            "default": null,
                            "description": "Field to extract from each dependency result before merging. Uses dot notation (e.g., \"result.score\").",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "merge_strategy": {
                            "default": null,
                            "description": "Strategy for merging multiple dependency outputs: - \"dict\": Return {node_name: result} passthrough (default for multi-dep) - \"list\": Return [result1, result2, ...] in dependency order - \"first\": Return first non-None result - \"last\": Return last non-None result - \"reduce\": Apply reducer function to values",
                            "enum": [
                                "dict",
                                "list",
                                "first",
                                "last",
                                "reduce"
                            ],
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "output_fields": {
                            "default": null,
                            "description": "Fields to include in output dict. If None, all computed expressions are returned.",
                            "items": {
                                "type": "string"
                            },
                            "type": [
                                "array",
                                "null"
                            ]
                        },
                        "reducer": {
                            "anyOf": [
                                {
                                    "type": "string"
                                },
                                {
                                    "description": "Module path string (e.g., 'myapp.process') or !py inline function",
                                    "type": "string"
                                }
                            ],
                            "default": null,
                            "description": "Module path (e.g., \"statistics.mean\") or callable for 'reduce' strategy. The function receives a list of values and returns a single result."
                        }
                    },
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "FunctionNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for function_node type",
            "properties": {
                "kind": {
                    "const": "function_node",
                    "description": "Node type: function_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "properties": {
                        "fn": {
                            "description": "Module path string (e.g., 'myapp.process')",
                            "type": "string"
                        }
                    },
                    "required": [
                        "fn"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "LlmNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for llm_node type",
            "properties": {
                "kind": {
                    "const": "llm_node",
                    "description": "Node type: llm_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "properties": {
                        "output_schema": {
                            "description": "Expected output schema for structured output validation",
                            "type": "object"
                        },
                        "parse_json": {
                            "default": false,
                            "description": "Parse the LLM response as JSON",
                            "type": "boolean"
                        },
                        "parse_strategy": {
                            "default": "json",
                            "description": "JSON parsing strategy",
                            "enum": [
                                "json",
                                "json_in_markdown",
                                "yaml"
                            ],
                            "type": "string"
                        },
                        "prompt_template": {
                            "description": "Template for the user prompt (Jinja2-style {{variable}} syntax)",
                            "type": "string"
                        },
                        "system_prompt": {
                            "description": "System message to prepend to the conversation",
                            "type": "string"
                        }
                    },
                    "required": [
                        "prompt_template"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "Node": {
            "description": "Base node structure",
            "properties": {
                "kind": {
                    "type": "string"
                },
                "metadata": {
                    "type": "object"
                },
                "spec": {
                    "type": "object"
                }
            },
            "type": "object"
        },
        "Port_CallNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for port_call_node type",
            "properties": {
                "kind": {
                    "const": "port_call_node",
                    "description": "Node type: port_call_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "additionalProperties": false,
                    "properties": {
                        "fallback": {
                            "default": null,
                            "description": "Value to return if the port is not available",
                            "type": "string"
                        },
                        "has_fallback": {
                            "default": false,
                            "description": "Set to True to enable fallback behavior (allows None as fallback)",
                            "type": "string"
                        },
                        "method": {
                            "description": "Method name to invoke on the port",
                            "type": "string"
                        },
                        "output_schema": {
                            "default": null,
                            "description": "Optional schema for validating/structuring the output",
                            "type": "string"
                        },
                        "port": {
                            "description": "Name of the port to call (e.g., \"database\", \"llm\", \"tool_router\")",
                            "type": "string"
                        }
                    },
                    "required": [
                        "port",
                        "method"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "Reasoning_AgentNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for reasoning_agent_node type",
            "properties": {
                "kind": {
                    "const": "reasoning_agent_node",
                    "description": "Node type: reasoning_agent_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "additionalProperties": false,
                    "properties": {
                        "config": {
                            "default": null,
                            "description": "Agent configuration",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "continuation_prompts": {
                            "additionalProperties": {
                                "type": "string"
                            },
                            "default": null,
                            "description": "Phase-specific prompts",
                            "type": [
                                "object",
                                "null"
                            ]
                        },
                        "main_prompt": {
                            "description": "Initial reasoning prompt",
                            "type": "string"
                        },
                        "output_schema": {
                            "anyOf": [
                                {
                                    "additionalProperties": {
                                        "type": "string"
                                    },
                                    "type": "object"
                                },
                                {
                                    "type": "string"
                                }
                            ],
                            "default": null,
                            "description": "Custom output schema for tool_end results"
                        }
                    },
                    "required": [
                        "main_prompt"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        },
        "Tool_CallNodeSpec": {
            "allOf": [
                {
                    "$ref": "#/$defs/Node"
                }
            ],
            "description": "Specification for tool_call_node type",
            "properties": {
                "kind": {
                    "const": "tool_call_node",
                    "description": "Node type: tool_call_node"
                },
                "metadata": {
                    "properties": {
                        "annotations": {
                            "description": "Optional metadata annotations",
                            "type": "object"
                        },
                        "name": {
                            "description": "Unique node identifier within the pipeline",
                            "type": "string"
                        }
                    },
                    "required": [
                        "name"
                    ],
                    "type": "object"
                },
                "spec": {
                    "additionalProperties": false,
                    "properties": {
                        "arguments": {
                            "default": null,
                            "description": "Arguments to pass to the tool (default: {})",
                            "type": [
                                "object",
                                "null"
                            ]
                        },
                        "tool_call_id": {
                            "default": null,
                            "description": "Optional ID for tracking (from LLM tool calls)",
                            "type": [
                                "string",
                                "null"
                            ]
                        },
                        "tool_name": {
                            "description": "Full module path to the tool function (e.g., 'mymodule.my_tool')",
                            "type": "string"
                        }
                    },
                    "required": [
                        "tool_name"
                    ],
                    "type": "object"
                }
            },
            "required": [
                "kind",
                "metadata",
                "spec"
            ],
            "type": "object"
        }
    },
    "$schema": "http://json-schema.org/draft-07/schema#",
    "description": "(auto-generated from builtin nodes)",
    "properties": {
        "apiVersion": {
            "default": "v1",
            "description": "API version",
            "type": "string"
        },
        "kind": {
            "const": "Pipeline",
            "description": "Resource kind (must be 'Pipeline')",
            "type": "string"
        },
        "metadata": {
            "properties": {
                "author": {
                    "description": "Pipeline author",
                    "type": "string"
                },
                "description": {
                    "description": "Pipeline description",
                    "type": "string"
                },
                "name": {
                    "description": "Unique pipeline identifier",
                    "type": "string"
                },
                "tags": {
                    "description": "Categorization tags",
                    "items": {
                        "type": "string"
                    },
                    "type": "array"
                },
                "version": {
                    "description": "Semantic version (e.g., 1.0.0)",
                    "type": "string"
                }
            },
            "required": [
                "name"
            ],
            "type": "object"
        },
        "spec": {
            "properties": {
                "common_field_mappings": {
                    "description": "Reusable field mapping definitions",
                    "type": "object"
                },
                "events": {
                    "description": "Event handlers for observability",
                    "properties": {
                        "on_node_completed": {
                            "items": {
                                "$ref": "#/$defs/EventHandler"
                            },
                            "type": "array"
                        },
                        "on_node_failed": {
                            "items": {
                                "$ref": "#/$defs/EventHandler"
                            },
                            "type": "array"
                        },
                        "on_node_started": {
                            "items": {
                                "$ref": "#/$defs/EventHandler"
                            },
                            "type": "array"
                        },
                        "on_workflow_complete": {
                            "items": {
                                "$ref": "#/$defs/EventHandler"
                            },
                            "type": "array"
                        }
                    },
                    "type": "object"
                },
                "input_schema": {
                    "description": "JSON Schema for pipeline inputs",
                    "type": "object"
                },
                "nodes": {
                    "description": "List of pipeline nodes",
                    "items": {
                        "oneOf": [
                            {
                                "$ref": "#/$defs/LlmNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/Reasoning_AgentNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/CompositeNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/DataNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/ExpressionNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/FunctionNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/Port_CallNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/Tool_CallNodeSpec"
                            },
                            {
                                "$ref": "#/$defs/AgentNodeSpec"
                            }
                        ]
                    },
                    "type": "array"
                },
                "output_schema": {
                    "description": "JSON Schema for pipeline outputs",
                    "type": "object"
                },
                "policies": {
                    "additionalProperties": {
                        "properties": {
                            "params": {
                                "description": "Policy parameters",
                                "type": "object"
                            },
                            "type": {
                                "description": "Policy type",
                                "type": "string"
                            }
                        },
                        "type": "object"
                    },
                    "description": "Execution policies (retry, timeout, error handling)",
                    "type": "object"
                },
                "ports": {
                    "additionalProperties": {
                        "properties": {
                            "adapter": {
                                "description": "Adapter type",
                                "type": "string"
                            },
                            "params": {
                                "description": "Adapter parameters",
                                "type": "object"
                            }
                        },
                        "type": "object"
                    },
                    "description": "Port adapters configuration (LLM, database, memory)",
                    "type": "object"
                },
                "type_ports": {
                    "additionalProperties": {
                        "type": "string"
                    },
                    "description": "Port type mappings",
                    "type": "object"
                }
            },
            "required": [
                "nodes"
            ],
            "type": "object"
        }
    },
    "required": [
        "kind",
        "metadata",
        "spec"
    ],
    "title": "hexDAG Pipeline",
    "type": "object"
}
